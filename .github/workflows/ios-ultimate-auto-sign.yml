name: ðŸš€ NEO STREAM - iOS Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild even if no changes'
        required: false
        default: 'false'

env:
  FLUTTER_VERSION: '3.24.5'
  IOS_VERSION: '12.0'
  APP_NAME: 'NEO STREAM'

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ðŸ“¦ Install dependencies
      run: |
        flutter pub get
        flutter pub deps
        
    - name: ðŸ§ª Run tests
      run: flutter test --coverage
      
    - name: ðŸŽ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: ðŸ”¢ Update version
      run: |
        # Mise Ã  jour automatique de la version
        BUILD_NUMBER=${{ github.run_number }}
        VERSION="1.0.0"
        
        # Mise Ã  jour pubspec.yaml
        sed -i '' "s/version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        
        # Mise Ã  jour iOS
        cd ios
        agvtool new-marketing-version $VERSION
        agvtool new-version -all $BUILD_NUMBER
        
        echo "ðŸ“± Version mise Ã  jour: $VERSION+$BUILD_NUMBER"
        
    - name: ðŸ—ï¸ Build iOS (unsigned)
      run: |
        echo "ðŸ—ï¸ Construction de l'application iOS (non signÃ©e)..."
        
        # Build Flutter sans signature
        flutter build ios --release --no-codesign
        
        echo "âœ… Build terminÃ©e"
        
    - name: ðŸ“¦ Create unsigned IPA
      run: |
        echo "ðŸ“¦ CrÃ©ation de l'IPA non signÃ©e..."
        
        cd build/ios/iphoneos
        
        # CrÃ©er la structure IPA
        mkdir -p Payload
        cp -r Runner.app Payload/
        
        # CrÃ©er l'IPA
        zip -r NEO-STREAM-v1.0.0-${{ github.run_number }}-UNSIGNED.ipa Payload/
        
        # DÃ©placer vers le rÃ©pertoire de build
        mkdir -p $RUNNER_TEMP/build
        mv NEO-STREAM-v1.0.0-${{ github.run_number }}-UNSIGNED.ipa $RUNNER_TEMP/build/
        
        echo "âœ… IPA non signÃ©e crÃ©Ã©e"
        
    - name: ðŸ“¤ Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: neostream-ios-signed-${{ github.run_number }}
        path: ${{ runner.temp }}/build/*.ipa
        retention-days: 30
        
    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.0-unsigned-${{ github.run_number }}
        name: ðŸš€ NEO STREAM v1.0.0 (Unsigned Build ${{ github.run_number }})
        body: |
          # ðŸš€ NEO STREAM - L'avenir du streaming est maintenant
          
          ## âœ¨ Version non signÃ©e - PrÃªte pour ESign
          
          ### ðŸ“± Installation avec ESign (RecommandÃ©)
          1. **TÃ©lÃ©chargez** le fichier IPA non signÃ© ci-dessous
          2. **Installez ESign** depuis [esign.yyyue.xyz](https://esign.yyyue.xyz)
          3. **Importez l'IPA** dans ESign
          4. **Signez et installez** automatiquement
          5. **Profitez** de NEO STREAM sans limite de temps !
          
          ### ðŸ” Avantages ESign
          - âœ… **Signature permanente** - Pas d'expiration
          - ðŸ”„ **Pas de renouvellement** nÃ©cessaire
          - ðŸ“± **Installation directe** sur l'appareil
          - ðŸŽ¯ **Build** #${{ github.run_number }}
          
          ### ðŸŽ® FonctionnalitÃ©s
          - ðŸŽ¨ **Interface cyberpunk** immersive
          - ðŸ‘¤ **12 avatars uniques** personnalisables
          - ðŸ“º **Streaming optimisÃ©** haute qualitÃ©
          - ðŸ”’ **Profils utilisateurs** sÃ©curisÃ©s
          - ðŸŒ **Configuration DNS** automatique
          
          ### ðŸ› ï¸ Informations techniques
          - **Version**: 1.0.0+${{ github.run_number }}
          - **Commit**: ${{ github.sha }}
          - **Flutter**: ${{ env.FLUTTER_VERSION }}
          - **Build date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Type**: IPA non signÃ©e (prÃªte pour ESign)
          
          ### ðŸ“‹ Guide d'installation dÃ©taillÃ©
          
          Consultez le **README.md** pour le guide complet d'installation avec ESign.
          
          ### ðŸ†• Alternatives d'installation
          - **ESign** (RecommandÃ©) - Signature permanente
          - **AltStore** - Gratuit, renouvellement nÃ©cessaire
          - **Sideloadly** - Gratuit, renouvellement nÃ©cessaire
          
          ---
          
          **ðŸ¤– Build automatique gÃ©nÃ©rÃ© par GitHub Actions**
          
          *NEO STREAM - OÃ¹ le cyberpunk rencontre le streaming* âš¡
        files: ${{ runner.temp }}/build/*.ipa
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ“Š Build summary
      run: |
        echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… **Build rÃ©ussi**: NEO STREAM v1.0.0+${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ **Type**: IPA non signÃ©e (prÃªte pour ESign)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± **CompatibilitÃ©**: iOS ${{ env.IOS_VERSION }}+" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ” **Installation**: Via ESign (signature permanente)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ **IPA disponible**: Dans les artifacts et releases" >> $GITHUB_STEP_SUMMARY